{% extends 'base.html' %}
{% load static %}

{% block title %}
AI-Recommendations
{% endblock %}

{% block styles %}
<style>
    body, html {
      height: 100%;
    }

    .chat-container {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      justify-content: center; /* Center content vertically */
      align-items: center; /* Center content horizontally */
      padding-left: 290px;  /* Remove or adjust this line */
      margin-top: 50px; /* Adjusted margin top */
    }

    .main-container {
      display: flex;
      height: 100%;
    }

    .container-box {
      background-color: #ffffff; /* White background */
      border-radius: 10px; /* Rounded corners */
      padding: 20px; /* Padding around the content */
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); /* Box shadow for a subtle effect */
      margin-bottom: 20px;
      width: 80%; /* Adjusted width */
    }

    .default-response-container {
      margin-top: 20px;
      display: none; /* Initially hide the default response container */
    }

    /* Loading spinner styles */
    .loading-spinner {
      text-align: center;
      margin-top: 10px;
    }

    .spinner-border {
      width: 2rem;
      height: 2rem;
      display: inline-block;
      border-width: 2px;
      border-color: currentColor;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spinner-border .75s linear infinite;
    }

    @keyframes spinner-border {
      to {
        transform: rotate(360deg);
      }
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
  <div class="chat-container">
    <ul class="list-unstyled messages-list">
      <h1 style="margin-top: 20px; padding-top: 20px;">Buddy Recommendations</h1>
      
      {% for subject, data in aggregated_data.items %}
      <div class="container-box">
        <h3 style="padding-top: 10px;">{{ subject|title }}</h3>
        <li>Assessments Taken: {{ data.assessments_taken }}</li>
        <li>Average Score: {{ data.average_score }} %<br><br></li>
        <!-- Pass subject to JavaScript function -->
        <button class="generate-recommendations-btn" data-subject="{{ subject }}">Generate Recommendations</button>
        
        <div class="recommendations-list" style="display: none;">
          <br><h5>Recommendations:</h5>
          <!-- Loading Spinner -->
          <div class="loading-spinner" style="display: none;">
            <div class="spinner-border text-primary" role="status">
              <span class="sr-only">Loading...</span>
            </div>
          </div>
          
          <!-- Display recommendations here -->
          
          <!-- Default Response Container -->
          <div class="default-response-container">
            <pre><p id="default-response-{{ subject }}"></p></pre>
          </div>
        </div>
        
      </div>
      {% endfor %}
      
    </ul>
  </div>
</div>

{% include 'sidebar.html' %}

<script>
 // JavaScript to toggle the visibility of recommendations and fetch updated default response
document.querySelectorAll('.generate-recommendations-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var containerBox = this.closest('.container-box'); // Find the closest container box
        var recommendationsList = containerBox.querySelector('.recommendations-list');
        var defaultResponseContainer = recommendationsList.querySelector('.default-response-container');
        var loadingSpinner = recommendationsList.querySelector('.loading-spinner'); // Select the loading spinner

        if (recommendationsList.style.display === 'none') {
            recommendationsList.style.display = 'block';
        } else {
            recommendationsList.style.display = 'none';
        }

        // Show the loading spinner
        loadingSpinner.style.display = 'block';

        // Retrieve subject from data attribute
        var subject = this.getAttribute('data-subject');

        // Send AJAX request to backend with subject
        fetch('/recommend/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'  // Add CSRF token for CSRF protection
            },
            body: JSON.stringify({ subject: subject })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Received recommendations:', data.default_response);
            var defaultResponseParagraph = document.getElementById('default-response-' + subject);
            defaultResponseParagraph.textContent = data.default_response;

            // Show default response container
            defaultResponseContainer.style.display = 'block';

            // Hide the loading spinner once recommendations are fetched
            loadingSpinner.style.display = 'none';

            // Adjust the width of the container
            adjustContainerWidth(containerBox);
            
            // Scroll to the bottom of the container
            containerBox.scrollTop = containerBox.scrollHeight;
        })
        .catch(error => {
            console.error('Error:', error);
            // Hide the loading spinner if there's an error
            loadingSpinner.style.display = 'none';
        });
    });
});

// Function to adjust the width of the container dynamically
function adjustContainerWidth(containerBox) {
    var pageWidth = document.documentElement.clientWidth; // Get the width of the page
    var maxWidth = 0.8 * pageWidth; // Set the maximum width to 80% of the page width
    containerBox.style.width = maxWidth + 'px'; // Set the width of the container
}

</script>

{% endblock %}
